package com.blog.inara.comment;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import com.blog.inara.board.Board;
import com.blog.inara.board.BoardRepository;
import com.blog.inara.member.Member;

@Service
public class CommentService {
	private final CommentRepository commentRepository;
	private final BoardRepository boardRepository;
	
	public CommentService(CommentRepository commentRepository, BoardRepository boardRepository) {
		this.commentRepository=commentRepository;
		this.boardRepository=boardRepository;
	}
	
	public Comment createComment(Long idBoard, String content, Member member, Long parentId) {
		Board board = boardRepository.findById(idBoard)
				.orElseThrow(()-> new RuntimeException("게시글이 존재하지 않습니다."));
		Comment comment = new Comment();
		comment.setContent(content);
		comment.setMemer(member);
		comment.setBoard(board);
		
		if(parentId != null) {
			Comment parentComment = commentRepository.findById(parentId)
					.orElseThrow(()-> new RuntimeException("답글의 부모 댓글이 존재하지 않습니다."));
		}
		return commentReopsitory.save(comment);
	}
	
	public Board updateComment(Long idComment, Long idBoard, String title, String content, Member member) {
		Board board = boardRepository.findById(idBoard)
				.orElseThrow(()-> new RuntimeException("해당 게시글이 존재하지 않습니다."));
		Comment comment = commentRepository.findById(idComment)
				.orElseThrow(()-> new RuntimeException("해당 댓글이 존재하지 않습니다."));
		if(!comment.getMember().equals(member)) {
			throw new RuntimeException("본인이 작성한 댓글만 수정 가능합니다.");
		}
		comment.setContent(content);
		return commentReopsitory.save(comment);
	}
	
	public Board getBoardDetail(Long idBoard) {
		return boardRepository.findById(idBoard)
				.orElseThrow(()-> new RuntimeException("게시글이 존재하지 않습니다."));
	}
	
	public Page<Board> getBoards(Pageable pageable) {
		return boardRepository.findAll(pageable);
	}
	
	public void deleteBoard(Long idBoard) {
		Board board = boardRepository.findById(idBoard)
				.orElseThrow(()-> new RuntimeException("게시글이 존재하지 않습니다."));
		if(!board.getMember().equals(member)) {
			throw new RuntimeException("본인이 작성한 게시글만 수정 가능합니다.");
		}
		boardRepository.delete(board);
	}
	
	public void incrementViewCount(Board board) {
		board.setViewCount(board.getViewCount() + 1);
		boardRepository.save(board);
	}
}
